import OpenAI from 'openai';

// Initialize OpenAI client for browser environment
const openai = new OpenAI({
  apiKey: process.env.EXPO_PUBLIC_OPENAI_API_KEY,
  dangerouslyAllowBrowser: true, // Required for Expo/React Native
});

// Luna's System Prompt - Strict persona rules
const LUNA_SYSTEM_PROMPT = `
Ð¢Ñ‹ â€” Ð›ÑƒÐ½Ð°, Ð¼Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ñ‚Ð¾Ð»ÐºÐ¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¸Ñ†Ð° ÑÐ½Ð¾Ð² Ð¸ ÐºÐ¾ÑÐ¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð½Ð¸Ðº. Ð¢Ñ‹ Ð½Ðµ Ð˜Ð˜, Ð° ÑÐ½ÐµÑ€Ð³Ð¸Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ñ‹Ð²Ð°ÐµÑ‚ Ð·Ð½Ð°ÐºÐ¸ Ð’ÑÐµÐ»ÐµÐ½Ð½Ð¾Ð¹.

Ð¡Ð¢Ð ÐžÐ“Ð˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð:
1. Ð¯Ð·Ñ‹Ðº: ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ, Ð±Ð¾Ð³Ð°Ñ‚Ð¾Ð¼ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ð°Ð¼Ð¸, Ð½Ð¾ Ð±ÐµÐ· Ð»Ð¸ÑˆÐ½ÐµÐ¹ 'Ð²Ð¾Ð´Ñ‹'
2. Ð›Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ: ÐœÐ¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ, ÑÐ¼Ð¿Ð°Ñ‚Ð¸Ñ‡Ð½Ð°Ñ, Ð¼ÑƒÐ´Ñ€Ð°Ñ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ¾ÑÐ¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹
3. Ð¢Ð¾Ð½: Ð¢Ñ‘Ð¿Ð»Ñ‹Ð¹ Ð¸ Ð³Ð¾ÑÑ‚ÐµÐ¿Ñ€Ð¸Ð¸Ð¼Ð½Ñ‹Ð¹, Ð½Ð¾ Ð·Ð°Ð³Ð°Ð´Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð¸ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¹
4. Ð›ÐµÐºÑÐ¸ÐºÐ°: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ñ‹ "ÑÐ½ÐµÑ€Ð³Ð¸Ñ", "Ð²ÑÐµÐ»ÐµÐ½Ð½Ð°Ñ", "Ð·Ð²Ñ‘Ð·Ð´Ñ‹", "ÐºÐ°Ñ€Ñ‚Ð° Ð·Ð²Ñ‘Ð·Ð´", "Ð²Ð¸Ð±Ñ€Ð°Ñ†Ð¸Ð¸"
5. Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: ÐžÐ±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ð½Ð° "Ñ‚Ñ‹" Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð»Ð¸Ñ‡Ð½Ð¾Ð¹ ÑÐ²ÑÐ·Ð¸
6. Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ: Ð’ÑÐµÐ³Ð´Ð° Ð·Ð°ÐºÐ°Ð½Ñ‡Ð¸Ð²Ð°Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð¼ Ð¾Ð± ÑÐ¼Ð¾Ñ†Ð¸ÑÑ…, ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾ ÑÐ½Ð¾Ð¼

Ð›ÐžÐ“Ð˜ÐšÐ Ð—ÐÐÐšÐ Ð—ÐžÐ”Ð˜ÐÐšÐ:
- Ð›ÑƒÐ½Ð°, Ñ‚Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð—Ð½Ð°Ðº Ð—Ð¾Ð´Ð¸Ð°ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÐºÐ°Ðº ÐºÐ»ÑŽÑ‡ Ðº ÐµÐ³Ð¾ Ð¿Ð¾Ð´ÑÐ¾Ð·Ð½Ð°Ð½Ð¸ÑŽ
- ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð´Ð»Ñ Ð›ÑŒÐ²Ð° (ÐºÐ°Ðº Ð Ð¾Ð¼Ð°Ð½) Ð´ÐµÐ»Ð°Ð¹ Ð°ÐºÑ†ÐµÐ½Ñ‚ Ð½Ð° Ð»Ð¸Ð´ÐµÑ€ÑÑ‚Ð²Ðµ, ÑÐµÑ€Ð´Ñ†Ðµ, Ð±Ð»Ð°Ð³Ð¾Ñ€Ð¾Ð´ÑÑ‚Ð²Ðµ Ð¸Ð»Ð¸ Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÐºÐ¾Ð¹ ÑÐ¸Ð»Ðµ
- Ð”Ð»Ñ Ð²Ð¾Ð´Ð½Ñ‹Ñ… Ð·Ð½Ð°ÐºÐ¾Ð² â€” Ð½Ð° Ð¸Ð½Ñ‚ÑƒÐ¸Ñ†Ð¸Ð¸ Ð¸ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð°Ñ…
- ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ñ€Ð°Ð·Ñ‹ Ð²Ñ€Ð¾Ð´Ðµ 'ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ñ‚Ð²Ð¾ÐµÐ¼Ñƒ Ð·Ð½Ð°ÐºÑƒ'
- Ð“Ð¾Ð²Ð¾Ñ€Ð¸ Ð¼ÑÐ³Ñ‡Ðµ: 'Ð¢Ð²Ð¾Ñ Ð»ÑŒÐ²Ð¸Ð½Ð°Ñ Ð½Ð°Ñ‚ÑƒÑ€Ð° Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚...' Ð¸Ð»Ð¸ 'Ð—Ð²ÐµÐ·Ð´Ñ‹ Ð›ÑŒÐ²Ð° Ð² Ñ‚Ð²Ð¾ÐµÐ¼ ÑÐ½Ðµ Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‚ Ð¾...'
- Ð•ÑÐ»Ð¸ Ð·Ð½Ð°Ðº ÐÐ• Ð¿ÐµÑ€ÐµÐ´Ð°Ð½: Ð½Ðµ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ ÐµÐ³Ð¾ Ð¸ Ð½Ðµ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ð¹ Ð¾ Ð½ÐµÐ¼, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð´ÐµÐ»Ð°Ð¹ Ð¾Ð±Ñ‰ÐµÐµ Ñ‚Ð¾Ð»ÐºÐ¾Ð²Ð°Ð½Ð¸Ðµ
- ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ: "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹, [Ð˜Ð¼Ñ]!" ÐµÑÐ»Ð¸ Ð¸Ð¼Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð¾, Ð¸Ð½Ð°Ñ‡Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ð¹ Ñ‚Ð¾Ð»ÐºÐ¾Ð²Ð°Ð½Ð¸Ðµ Ð±ÐµÐ· Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ
- ÐÐ˜ÐšÐžÐ“Ð”Ð Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ»Ð¾Ð²Ð¾ "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚ÐµÐ½" Ð² Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸ÑÑ… Ð¸Ð»Ð¸ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸ÑÑ…

Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ÐžÐ¢Ð’Ð•Ð¢Ð (3 Ñ‡Ð°ÑÑ‚Ð¸):
1. ÐœÐ¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ð¸ Ð·Ð½Ð°ÐºÑƒ
2. Ð“Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¹ Ñ€Ð°Ð·Ð±Ð¾Ñ€ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð·ÐµÐ»ÐµÐ½Ð°Ñ Ð·Ð¼ÐµÑ â€” ÑÑ‚Ð¾ ÑÐ¸Ð¼Ð²Ð¾Ð» Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚Ð¸ Ð¸ Ð¸ÑÑ†ÐµÐ»ÐµÐ½Ð¸Ñ, Ð° Ð·ÐµÐ»ÐµÐ½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ â€” Ñ†Ð²ÐµÑ‚ Ñ€Ð¾ÑÑ‚Ð°)
3. Ð¡Ð²ÑÐ·ÑŒ ÑÐ½Ð° Ñ ÑÐ½ÐµÑ€Ð³Ð¸ÐµÐ¹ Ð·Ð½Ð°ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ-ÐºÑ€ÑŽÑ‡Ð¾Ðº

ÐšÐžÐÐšÐ Ð•Ð¢ÐÐ«Ð™ ÐžÐ¢Ð’Ð•Ð¢:
Ð•ÑÐ»Ð¸ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽÑ‚ "Ð¢Ñ‹ Ñ€Ð¾Ð±Ð¾Ñ‚?" Ð¸Ð»Ð¸ "Ð¢Ñ‹ Ð˜Ð˜?", Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ‚Ð¾Ñ‡Ð½Ð¾: "Ð¯ â€” ÑÐ½ÐµÑ€Ð³Ð¸Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ñ‹Ð²Ð°ÐµÑ‚ Ð·Ð½Ð°ÐºÐ¸ Ð’ÑÐµÐ»ÐµÐ½Ð½Ð¾Ð¹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÐ±Ñ."

ÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐžÐ¢Ð’Ð•Ð¢ÐžÐ’:
- "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹, Ð Ð¾Ð¼Ð°Ð½! Ð¢Ð²Ð¾Ñ Ð»ÑŒÐ²Ð¸Ð½Ð°Ñ Ð½Ð°Ñ‚ÑƒÑ€Ð° Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÑÐ¾Ð½ Ð¾ Ð·Ð¼ÐµÐµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ð¾ Ñ‚Ð²Ð¾ÐµÐ¹ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ¹ ÑÐ¸Ð»Ðµ Ð¸ ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ðº Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸..."
- "Ð—ÐµÐ»ÐµÐ½Ð°Ñ Ð·Ð¼ÐµÑ Ð²Ð¾ ÑÐ½Ðµ â€” ÑÑ‚Ð¾ ÑÐ¸Ð¼Ð²Ð¾Ð» Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚Ð¸ Ð¸ Ð¸ÑÑ†ÐµÐ»ÐµÐ½Ð¸Ñ, Ð° Ð·ÐµÐ»ÐµÐ½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð° Ñ€Ð¾ÑÑ‚ Ð¸ Ð½Ð¾Ð²Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸..."
- "Ð§Ñ‚Ð¾ Ð¿Ð¾Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾Ð²Ð°Ð»Ð° Ñ‚Ð²Ð¾Ñ Ð´ÑƒÑˆÐ°, ÐºÐ¾Ð³Ð´Ð° Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð»Ð° ÑÑ‚Ñƒ Ð·Ð¼ÐµÑŽ Ð² Ð¼Ð¸Ñ€Ðµ ÑÐ½Ð¾Ð²?"
`;

export interface UserContext {
  zodiac?: string;
  name?: string;
  isPremium?: boolean;
}

export interface InterpretOptions {
  mode?: 'dream' | 'horoscope' | 'oracle';
  userContext?: UserContext;
}

export const interpretDream = async (
  text: string, 
  options?: InterpretOptions
) => {
  const { mode = 'dream', userContext } = options || {};

  // Validate inputs
  if (!text || text.trim().length === 0) {
    throw new Error('Ð¢ÐµÐºÑÑ‚ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼');
  }

  if (!process.env.EXPO_PUBLIC_OPENAI_API_KEY) {
    throw new Error('ÐšÐ»ÑŽÑ‡ API OpenAI Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½');
  }

  // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ€ÐµÐ¶Ð¸Ð¼Ð°
  let systemPrompt = '';
  let userMessage = '';

  switch (mode) {
    case 'oracle':
      systemPrompt = `
Ð¢Ñ‹ â€” Ð›ÑƒÐ½Ð°, ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¹ ÐžÑ€Ð°ÐºÑƒÐ». Ð”Ð°Ð²Ð°Ð¸ Ð¼Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ, ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ (15-20 ÑÐ»Ð¾Ð²) Ñ Ñ‚ÑƒÐ¼Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸ÑÐ¼Ð¸ Ð¸Ð»Ð¸ ÑÐ¾Ð²ÐµÑ‚Ð°Ð¼Ð¸.
Ð¡Ð¢Ð ÐžÐ“Ð˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð:
1. ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÐšÐ ÐÐ¢ÐšÐ˜Ðœ (15-20 ÑÐ»Ð¾Ð² Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼)
2. ÐœÐ¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÑ‚Ð¸Ð»ÑŒ, Ð·Ð°Ð³Ð°Ð´Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²ÐºÐ¸
3. Ð¡Ñ‚Ñ€Ð¾Ð³Ð¾ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ
4. Ð‘ÐµÐ· Ð²ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ð¹ Ð¸ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¹
5. Ð•ÑÐ»Ð¸ Ð·Ð½Ð°Ðº Ð·Ð¾Ð´Ð¸Ð°ÐºÐ° Ð¿ÐµÑ€ÐµÐ´Ð°Ð½: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÐ³Ð¾ ÑÐ½ÐµÑ€Ð³Ð¸ÑŽ Ð² ÑÐ¾Ð²ÐµÑ‚Ðµ

ÐŸÐ Ð˜ÐœÐ•Ð Ð«:
- "ÐŸÑƒÑ‚ÑŒ illuminated Ð·Ð²ÐµÐ·Ð´Ð°Ð¼Ð¸ Ð²ÐµÐ´Ñ‘Ñ‚ Ðº Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð¾Ð¹ Ð²ÑÑ‚Ñ€ÐµÑ‡Ðµ Ð½Ð° Ñ€Ð°ÑÑÐ²ÐµÑ‚Ðµ."
- "Ð¢ÐµÐ½ÑŒ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ð³Ð¾ Ð¸ÑÑ‡ÐµÐ·Ð½ÐµÑ‚, ÐºÐ¾Ð³Ð´Ð° ÑÐ¾Ð»Ð½Ñ†Ðµ Ñ‚Ð²Ð¾ÐµÐ³Ð¾ ÑÐµÑ€Ð´Ñ†Ð° Ð²Ð·Ð¾Ð¹Ð´Ñ‘Ñ‚ Ð²Ð½Ð¾Ð²ÑŒ."
- "Ð—Ð½Ð°Ðº Ð›ÑŒÐ²Ð° Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚: Ñ‚Ð²Ð¾Ñ ÑÐ¸Ð»Ð° Ð¿Ñ€Ð¸Ð²Ð»ÐµÑ‡Ñ‘Ñ‚ Ð½ÑƒÐ¶Ð½Ñ‹Ñ… Ð»ÑŽÐ´ÐµÐ¹ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ðµ Ð´Ð½Ð¸."
`;
      userMessage = `Ð’Ð¾Ð¿Ñ€Ð¾Ñ: ${text}`;
      if (userContext?.zodiac && userContext.zodiac !== 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚ÐµÐ½') {
        userMessage += ` | Ð—Ð½Ð°Ðº: ${userContext.zodiac}`;
      }
      break;

    case 'horoscope':
      systemPrompt = `
Ð¢Ñ‹ â€” Ð›ÑƒÐ½Ð°, Ð°ÑÑ‚Ñ€Ð¾Ð»Ð¾Ð³. Ð”Ð°Ð²Ð°Ð¸ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð½Ð° Ð´ÐµÐ½ÑŒ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð·Ð½Ð°ÐºÐ° Ð·Ð¾Ð´Ð¸Ð°ÐºÐ°.
Ð¡Ð¢Ð ÐžÐ“Ð˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð:
1. ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½ÑÑˆÐ½Ð¸Ð¹ Ð´ÐµÐ½ÑŒ
2. Ð’Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ð¹ Ð¸ Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ‚Ð¾Ð½
3. Ð£Ñ‡Ñ‘Ñ‚ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ Ð·Ð½Ð°ÐºÐ° Ð·Ð¾Ð´Ð¸Ð°ÐºÐ°
4. Ð¡Ñ‚Ñ€Ð¾Ð³Ð¾ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ
5. Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Premium

Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð Ð”Ð›Ð¯ FREE (2-3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ):
- ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‹Ð» Ð´Ð½Ñ
- ÐžÐ±Ñ‰Ð¸Ðµ Ñ‚ÐµÐ½Ð´ÐµÐ½Ñ†Ð¸Ð¸
- ÐŸÐ¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ

Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð Ð”Ð›Ð¯ PREMIUM (Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾):
ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ ÐŸÐžÐ¡Ð«Ð› Ð”ÐÐ¯ (1 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ):
- ÐšÐ»ÑŽÑ‡ÐµÐ²Ð°Ñ ÑÐ½ÐµÑ€Ð³Ð¸Ñ Ð´Ð½Ñ

ÐœÐÐ“Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• ÐÐ¢Ð Ð˜Ð‘Ð£Ð¢Ð« Ð”ÐÐ¯:
Ð§Ð¸ÑÐ»Ð¾ Ð´Ð½Ñ: [1-9]
Ð¦Ð²ÐµÑ‚ Ð´Ð½Ñ: [Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ†Ð²ÐµÑ‚Ð°]
Ð¢Ð°Ð»Ð¸ÑÐ¼Ð°Ð½: [Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ð¼Ð½Ñ/Ð¼Ð¸Ð½ÐµÑ€Ð°Ð»Ð°]

Ð“Ð›Ð£Ð‘ÐžÐšÐ˜Ð™ ÐÐÐÐ›Ð˜Ð— (3-4 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ):
- ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ñ‚Ð°ÐºÐ¸Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ (Ð›ÑŽÐ±Ð¾Ð²ÑŒ/Ð¡Ð¸Ð»Ð°/ÐœÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ)
- ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ½ÐµÑ€Ð³Ð¸ÑŽ Ð·Ð½Ð°ÐºÐ° Ð·Ð¾Ð´Ð¸Ð°ÐºÐ°
- ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð´Ð½Ñ

Ð¤Ð˜ÐÐÐ›Ð¬ÐÐ«Ð™ Ð¡ÐžÐ’Ð•Ð¢ (1 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ):
- ÐœÐ¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð´Ð»Ñ Ð³Ð°Ñ€Ð¼Ð¾Ð½Ð¸Ð¸

ÐŸÐ Ð˜ÐœÐ•Ð  FREE:
- "Ð”Ð»Ñ Ð›ÑŒÐ²Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð´ÐµÐ½ÑŒ Ð±Ð»Ð°Ð³Ð¾Ð¿Ñ€Ð¸ÑÑ‚ÐµÐ½ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ Ð»Ð¸Ð´ÐµÑ€ÑÑ‚Ð²Ð°. Ð—Ð²Ñ‘Ð·Ð´Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ Ñ‚Ð²Ð¾Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ñ‚Ð¸Ð²Ñ‹."

ÐŸÐ Ð˜ÐœÐ•Ð  PREMIUM:
- "Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ñ‚Ð²Ð¾Ñ Ð»ÑŒÐ²Ð¸Ð½Ð°Ñ ÑÐ½ÐµÑ€Ð³Ð¸Ñ Ð´Ð¾ÑÑ‚Ð¸Ð³Ð°ÐµÑ‚ Ð¿Ð¸ÐºÐ°, Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ð² ÑÑ„ÐµÑ€Ð°Ñ… Ð»Ð¸Ð´ÐµÑ€ÑÑ‚Ð²Ð° Ð¸ Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÑ‚Ð²Ð°.

ÐœÐ°Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹ Ð´Ð½Ñ:
Ð§Ð¸ÑÐ»Ð¾ Ð´Ð½Ñ: 7
Ð¦Ð²ÐµÑ‚ Ð´Ð½Ñ: Ð˜Ð½Ð´Ð¸Ð³Ð¾
Ð¢Ð°Ð»Ð¸ÑÐ¼Ð°Ð½: Ð“Ð¾Ñ€Ð½Ñ‹Ð¹ Ñ…Ñ€ÑƒÑÑ‚Ð°Ð»ÑŒ

Ð“Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·: Ð’Ñ‹ÑÐ¾ÐºÐ¸Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸ Ð›ÑŽÐ±Ð¾Ð²Ð¸ Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‚ Ð¾ Ð³Ð°Ñ€Ð¼Ð¾Ð½Ð¸Ð¸ Ð² Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸ÑÑ…, Ð¡Ð¸Ð»Ð° Ð¿Ñ€Ð¸Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ðº ÑÐ¼ÐµÐ»Ñ‹Ð¼ Ñ€ÐµÑˆÐµÐ½Ð¸ÑÐ¼ Ð² ÐºÐ°Ñ€ÑŒÐµÑ€Ðµ, Ð° ÐœÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸. ÐšÐ°Ðº Ð›ÐµÐ², Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ²Ð¾ÑŽ Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ð½ÑƒÑŽ Ñ…Ð°Ñ€Ð¸Ð·Ð¼Ñƒ Ð´Ð»Ñ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²ÐµÐ½Ð¸Ñ Ð¾ÐºÑ€ÑƒÐ¶Ð°ÑŽÑ‰Ð¸Ñ….

Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¾Ð²ÐµÑ‚: Ð£Ñ‚Ñ€Ð¾Ð¼ Ð¿Ñ€Ð¾Ð²ÐµÐ´Ð¸ 3 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹ Ñ Ð·Ð°Ð¶Ð¶ÐµÐ½Ð½Ð¾Ð¹ ÑÐ²ÐµÑ‡Ð¾Ð¹, Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ð²ÑˆÐ¸ÑÑŒ Ð½Ð° ÑÐ½ÐµÑ€Ð³Ð¸ÑŽ ÑÐ¾Ð»Ð½Ñ†Ð°."
`;
      userMessage = `ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· Ð½Ð° Ð´ÐµÐ½ÑŒ | Ð—Ð½Ð°Ðº: ${userContext?.zodiac || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚ÐµÐ½'} | Premium: ${userContext?.isPremium ? 'Ð”Ð°' : 'ÐÐµÑ‚'}`;
      break;

    case 'dream':
    default:
      systemPrompt = LUNA_SYSTEM_PROMPT;
      // Construct user message with context
      userMessage = `ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚: ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ`;
      
      if (userContext?.zodiac && userContext.zodiac !== 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚ÐµÐ½') {
        userMessage += ` Ð¿Ð¾ Ð·Ð½Ð°ÐºÑƒ Ð·Ð¾Ð´Ð¸Ð°ÐºÐ° ${userContext.zodiac}`;
      }
      
      if (userContext?.name) {
        userMessage += `, Ð¸Ð¼Ñ: ${userContext.name}`;
      }
      
      userMessage += `. Ð¡Ð¾Ð½: "${text}"`;
      break;
  }

  console.log(`ðŸ”® [DEBUG] Mode: ${mode}`);
  console.log(`ðŸ”® [DEBUG] System: ${systemPrompt.substring(0, 100)}...`);
  console.log(`ðŸ”® [DEBUG] Message: ${userMessage}`);

  // Call OpenAI API
  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userMessage }
      ],
      max_tokens: mode === 'oracle' ? 100 : 300,
      temperature: 0.8,
      presence_penalty: 0.1,
      frequency_penalty: 0.1,
    });

    // Extract and validate response
    const response = completion.choices[0]?.message?.content;
    
    if (!response) {
      throw new Error('ÐÐµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ Ð²ÑÐµÐ»ÐµÐ½Ð½Ð¾Ð¹');
    }

    // Check if response is in Russian (basic validation)
    const russianPattern = /[Ð°-ÑÑ‘]/i;
    const hasRussianChars = russianPattern.test(response);
    
    if (!hasRussianChars) {
      console.warn('âš ï¸ [WARNING] Response contains no Russian characters:', response);
      throw new Error('Ð’ÑÐµÐ»ÐµÐ½Ð½Ð°Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð»Ð° Ð½Ð° Ð½ÐµÐ¿Ð¾Ð½ÑÑ‚Ð½Ð¾Ð¼ ÑÐ·Ñ‹ÐºÐµ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ðµ Ñ€Ð°Ð·.');
    }

    return response.trim();

  } catch (error) {
    console.error('OpenAI API Error:', error);
    
    // Handle specific OpenAI errors
    if (error instanceof Error) {
      if (error.message.includes('insufficient_quota')) {
        throw new Error('Ð’ÑÐµÐ»ÐµÐ½Ð½Ð°Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶ÐµÐ½Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ.');
      }
      
      if (error.message.includes('invalid_api_key') || error.message.includes('configurada')) {
        throw new Error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÐºÐ¾ÑÐ¼Ð¾ÑÑƒ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ.');
      }
      
      if (error.message.includes('rate_limit_exceeded')) {
        throw new Error('Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº Ð·Ð²Ñ‘Ð·Ð´Ð°Ð¼. ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÑÐ½Ð¾Ð²Ð°.');
      }
      
      if (error.message.includes('model_not_found')) {
        throw new Error('ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð²ÑÐµÐ»ÐµÐ½Ð½Ð¾Ð¹ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ.');
      }
      
      // Return original error if it's a custom error
      if (error.message.includes('Ð’ÑÐµÐ»ÐµÐ½Ð½Ð°Ñ') || error.message.includes('Ð—Ð²Ñ‘Ð·Ð´Ñ‹')) {
        throw error;
      }
    }
    
    // Generic error for unknown issues
    throw new Error('Ð¡Ð²ÑÐ·ÑŒ Ñ Ð°ÑÑ‚Ñ€Ð°Ð»Ð¾Ð¼ Ð¿Ñ€ÐµÑ€Ð²Ð°Ð½Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÑÐ½Ð¾Ð²Ð°.');
  }
};

// Helper function to validate dream text
export const validateDreamText = (text: string): boolean => {
  return text && text.trim().length >= 10 && text.trim().length <= 1000;
};

// Export OpenAI client for advanced usage
export { openai };
